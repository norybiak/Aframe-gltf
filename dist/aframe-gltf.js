/**
 *  glTF component and primitive compatibility for aframe 0.3.0.
 *   
 * NorybiaK
 * v0.3.0
 */
 
//Lets allow older version of Three.js to work with the latest GLTFLoader.
THREE.FileLoader = THREE.FileLoader || THREE.XHRLoader;

/**
 * glTF model system.
 */
 
AFRAME.registerSystem('gltf-model', {
  init: function () {
    this.models = [];
  },
   
  /**
   * Registers a glTF asset.
   * @param {object} gltf Asset containing a scene and (optional) animations and cameras.
   */
  registerModel: function (gltf) {
    this.models.push(gltf);
  },

  /**
   * Unregisters a glTF asset.
   * @param  {object} gltf Asset containing a scene and (optional) animations and cameras.
   */
  unregisterModel: function (gltf) {
    var models = this.models;
    var index = models.indexOf(gltf);
    if (index >= 0) {
      models.splice(index, 1);
    }
  }
});

/**
 * glTF model loader.
 */
 
AFRAME.registerComponent('gltf-model', {
  schema: { type: 'string' },

  init: function () {
    this.model = null;
    this.loader = new THREE.GLTFLoader();
	this.loader.setCrossOrigin('anonymous');
  },

  update: function () {
    var self = this;
    var el = this.el;
    var src = this.data;
	
    if (!src) { return; }

    this.remove();
    this.loader.load(src, function gltfLoaded (gltfModel) {
      self.model = gltfModel.scene;
      self.system.registerModel(self.model);
      el.setObject3D('mesh', self.model);
      el.emit('model-loaded', {format: 'gltf', model: self.model});
	  
    });
  },

  remove: function () {
    if (!this.model) { return; }
    this.el.removeObject3D('mesh');
    this.system.unregisterModel(this.model);
  }
});

/**
 * glTF model primitive.
 */
 
AFRAME.registerPrimitive('a-gltf-model', {
  mappings: {
    src: 'gltf-model'
  }
});
THREE.GLTFLoader=function(){function e(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager}function a(){var e={};return{get:function(a){return e[a]},add:function(a,t){e[a]=t},remove:function(a){delete e[a]},removeAll:function(){e={}}}}function t(e){this.name=E.KHR_LIGHTS,this.lights={};var a=e.extensions&&e.extensions[E.KHR_LIGHTS]||{},t=a.lights||{};for(var r in t){var n,s=t[r],i=(new THREE.Color).fromArray(s.color);switch(s.type){case"directional":n=new THREE.DirectionalLight(i),n.position.set(0,0,1);break;case"point":n=new THREE.PointLight(i);break;case"spot":n=new THREE.SpotLight(i),n.position.set(0,0,1);break;case"ambient":n=new THREE.AmbientLight(i)}n&&(void 0!==s.constantAttenuation&&(n.intensity=s.constantAttenuation),void 0!==s.linearAttenuation&&(n.distance=1/s.linearAttenuation),void 0!==s.quadraticAttenuation&&(n.decay=s.quadraticAttenuation),void 0!==s.fallOffAngle&&(n.angle=s.fallOffAngle),void 0!==s.fallOffExponent&&console.warn("THREE.GLTFLoader:: light.fallOffExponent not currently supported."),n.name=s.name||"light_"+r,this.lights[r]=n)}}function r(e){this.name=E.KHR_MATERIALS_COMMON}function n(e){this.name=E.KHR_BINARY_GLTF,this.content=null,this.body=null;var a=new DataView(e,0,m);if(this.header={magic:l(new Uint8Array(e.slice(0,4))),version:a.getUint32(4,!0),length:a.getUint32(8,!0)},this.header.magic!==d)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected. Use GLTFLoader instead.");for(var t=new DataView(e,m),r=0;r<t.byteLength;){var n=t.getUint32(r,!0);r+=4;var s=t.getUint32(r,!0);if(r+=4,s===f.JSON){var i=new Uint8Array(e,m+r,n);this.content=l(i)}else if(s===f.BIN){var o=m+r;this.body=e.slice(o,o+n)}r+=n}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}function s(){return{name:E.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return THREE.ShaderMaterial},extendParams:function(e,a,t){var r=a.extensions[this.name],n=THREE.ShaderLib.standard,s=THREE.UniformsUtils.clone(n.uniforms),i=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),o=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),l=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),u=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),c=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb;","material.specularRoughness = clamp( 1.0 - glossinessFactor, 0.04, 1.0 );","material.specularColor = specularFactor.rgb;"].join("\n"),p=n.fragmentShader.replace("#include <specularmap_fragment>","").replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",i).replace("#include <metalnessmap_pars_fragment>",o).replace("#include <roughnessmap_fragment>",l).replace("#include <metalnessmap_fragment>",u).replace("#include <lights_physical_fragment>",c);delete s.roughness,delete s.metalness,delete s.roughnessMap,delete s.metalnessMap,s.specular={value:(new THREE.Color).setHex(1118481)},s.glossiness={value:.5},s.specularMap={value:null},s.glossinessMap={value:null},e.vertexShader=n.vertexShader,e.fragmentShader=p,e.uniforms=s,e.defines={STANDARD:""},e.color=new THREE.Color(1,1,1),e.opacity=1;var E=[];if(Array.isArray(r.diffuseFactor)){var d=r.diffuseFactor;e.color.fromArray(d),e.opacity=d[3]}if(void 0!==r.diffuseTexture&&E.push(t.assignTexture(e,"map",r.diffuseTexture.index)),e.emissive=new THREE.Color(0,0,0),e.glossiness=void 0!==r.glossinessFactor?r.glossinessFactor:1,e.specular=new THREE.Color(1,1,1),Array.isArray(r.specularFactor)&&e.specular.fromArray(r.specularFactor),void 0!==r.specularGlossinessTexture){var m=r.specularGlossinessTexture.index;E.push(t.assignTexture(e,"glossinessMap",m)),E.push(t.assignTexture(e,"specularMap",m))}return Promise.all(E)},createMaterial:function(e){var a=new THREE.ShaderMaterial({defines:e.defines,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,fog:!0,lights:!0,opacity:e.opacity,transparent:e.transparent});return a.isGLTFSpecularGlossinessMaterial=!0,a.color=e.color,a.map=void 0===e.map?null:e.map,a.lightMap=null,a.lightMapIntensity=1,a.aoMap=void 0===e.aoMap?null:e.aoMap,a.aoMapIntensity=1,a.emissive=e.emissive,a.emissiveIntensity=1,a.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,a.bumpMap=void 0===e.bumpMap?null:e.bumpMap,a.bumpScale=1,a.normalMap=void 0===e.normalMap?null:e.normalMap,e.normalScale&&(a.normalScale=e.normalScale),a.displacementMap=null,a.displacementScale=1,a.displacementBias=0,a.specularMap=void 0===e.specularMap?null:e.specularMap,a.specular=e.specular,a.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,a.glossiness=e.glossiness,a.alphaMap=null,a.envMap=void 0===e.envMap?null:e.envMap,a.envMapIntensity=1,a.refractionRatio=.98,a.extensions.derivatives=!0,a},cloneMaterial:function(e){var a=e.clone();a.isGLTFSpecularGlossinessMaterial=!0;for(var t=this.specularGlossinessParams,r=0;r<t.length;r++)a[t[r]]=e[t[r]];return a},refreshUniforms:function(e,a,t,r,n,s){var i=n.uniforms,o=n.defines;i.opacity.value=n.opacity,i.diffuse.value.copy(n.color),i.emissive.value.copy(n.emissive).multiplyScalar(n.emissiveIntensity),i.map.value=n.map,i.specularMap.value=n.specularMap,i.alphaMap.value=n.alphaMap,i.lightMap.value=n.lightMap,i.lightMapIntensity.value=n.lightMapIntensity,i.aoMap.value=n.aoMap,i.aoMapIntensity.value=n.aoMapIntensity;var l;if(n.map?l=n.map:n.specularMap?l=n.specularMap:n.displacementMap?l=n.displacementMap:n.normalMap?l=n.normalMap:n.bumpMap?l=n.bumpMap:n.glossinessMap?l=n.glossinessMap:n.alphaMap?l=n.alphaMap:n.emissiveMap&&(l=n.emissiveMap),void 0!==l){l.isWebGLRenderTarget&&(l=l.texture);var u,c;if(void 0!==l.matrix){if(l.matrixAutoUpdate===!0){u=l.offset,c=l.repeat;var p=l.rotation,E=l.center;l.matrix.setUvTransform(u.x,u.y,c.x,c.y,p,E.x,E.y)}i.uvTransform.value.copy(l.matrix)}else u=l.offset,c=l.repeat,i.offsetRepeat.value.set(u.x,u.y,c.x,c.y)}i.envMap.value=n.envMap,i.envMapIntensity.value=n.envMapIntensity,i.flipEnvMap.value=n.envMap&&n.envMap.isCubeTexture?-1:1,i.refractionRatio.value=n.refractionRatio,i.specular.value.copy(n.specular),i.glossiness.value=n.glossiness,i.glossinessMap.value=n.glossinessMap,i.emissiveMap.value=n.emissiveMap,i.bumpMap.value=n.bumpMap,i.normalMap.value=n.normalMap,i.displacementMap.value=n.displacementMap,i.displacementScale.value=n.displacementScale,i.displacementBias.value=n.displacementBias,null!==i.glossinessMap.value&&void 0===o.USE_GLOSSINESSMAP&&(o.USE_GLOSSINESSMAP="",o.USE_ROUGHNESSMAP=""),null===i.glossinessMap.value&&void 0!==o.USE_GLOSSINESSMAP&&(delete o.USE_GLOSSINESSMAP,delete o.USE_ROUGHNESSMAP)}}}function i(e,a,t){if(!e)return Promise.resolve();var r,n=[];if("[object Array]"===Object.prototype.toString.call(e)){r=[];for(var s=e.length,i=0;i<s;i++){var o=a.call(t||this,e[i],i);o&&(o instanceof Promise?o=o.then(function(e,a){r[e]=a}.bind(this,i)):r[i]=o,n.push(o))}}else{r={};for(var l in e)if(e.hasOwnProperty(l)){var o=a.call(t||this,e[l],l);o&&(o instanceof Promise?o=o.then(function(e,a){r[e]=a}.bind(this,l)):r[l]=o,n.push(o))}}return Promise.all(n).then(function(){return r})}function o(e,a){return"string"!=typeof e||""===e?"":/^(https?:)?\/\//i.test(e)?e:/^data:.*,.*$/i.test(e)?e:/^blob:.*$/i.test(e)?e:a+e}function l(e){if(void 0!==window.TextDecoder)return(new TextDecoder).decode(e);for(var a="",t=0,r=e.length;t<r;t++)a+=String.fromCharCode(e[t]);return a}function u(){return new THREE.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:THREE.FrontSide})}function c(e,a,t,r){var n=e.geometry,s=e.material,i=t.targets,o=n.morphAttributes;o.position=[],o.normal=[],s.morphTargets=!0;for(var l=0,u=i.length;l<u;l++){var c,p,E=i[l],d="morphTarget"+l;if(void 0!==E.POSITION){c=r.accessors[E.POSITION].clone();for(var m=n.attributes.position,f=0,h=c.count;f<h;f++)c.setXYZ(f,c.getX(f)+m.getX(f),c.getY(f)+m.getY(f),c.getZ(f)+m.getZ(f))}else n.attributes.position&&(c=n.attributes.position.clone());if(void 0!==c&&(c.name=d,o.position.push(c)),void 0!==E.NORMAL){s.morphNormals=!0,p=r.accessors[E.NORMAL].clone();for(var T=n.attributes.normal,f=0,h=p.count;f<h;f++)p.setXYZ(f,p.getX(f)+T.getX(f),p.getY(f)+T.getY(f),p.getZ(f)+T.getZ(f))}else void 0!==n.attributes.normal&&(p=n.attributes.normal.clone());void 0!==p&&(p.name=d,o.normal.push(p))}if(e.updateMorphTargets(),void 0!==a.weights)for(var l=0,u=a.weights.length;l<u;l++)e.morphTargetInfluences[l]=a.weights[l]}function p(e,t,r){this.json=e||{},this.extensions=t||{},this.options=r||{},this.cache=new a,this.textureLoader=new THREE.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new THREE.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer")}e.prototype={constructor:e,crossOrigin:"Anonymous",load:function(e,a,t,r){var n=this,s=void 0!==this.path?this.path:THREE.Loader.prototype.extractUrlBase(e),i=new THREE.FileLoader(n.manager);i.setResponseType("arraybuffer"),i.load(e,function(e){try{n.parse(e,s,a,r)}catch(e){void 0!==r&&r(e.constructor===Error?e:new Error("THREE.GLTFLoader: Unable to parse model."))}},t,r)},setCrossOrigin:function(e){this.crossOrigin=e},setPath:function(e){this.path=e},parse:function(e,a,i,o){var u,c={};if("string"==typeof e)u=e;else{var m=l(new Uint8Array(e,0,4));if(m===d){try{c[E.KHR_BINARY_GLTF]=new n(e)}catch(e){return void(o&&o(e))}u=c[E.KHR_BINARY_GLTF].content}else u=l(new Uint8Array(e))}var f=JSON.parse(u);if(void 0===f.asset||f.asset.version[0]<2)return void(o&&o(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));f.extensionsUsed&&(f.extensionsUsed.indexOf(E.KHR_LIGHTS)>=0&&(c[E.KHR_LIGHTS]=new t(f)),f.extensionsUsed.indexOf(E.KHR_MATERIALS_COMMON)>=0&&(c[E.KHR_MATERIALS_COMMON]=new r(f)),f.extensionsUsed.indexOf(E.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS)>=0&&(c[E.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]=new s)),console.time("GLTFLoader");var h=new p(f,c,{path:a||this.path||"",crossOrigin:this.crossOrigin,manager:this.manager});h.parse(function(e,a,t,r){console.timeEnd("GLTFLoader");var n={scene:e,scenes:a,cameras:t,animations:r};i(n)},o)}};var E={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_LIGHTS:"KHR_lights",KHR_MATERIALS_COMMON:"KHR_materials_common",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness"};r.prototype.getMaterialType=function(e){var a=e.extensions[this.name];switch(a.type){case"commonBlinn":case"commonPhong":return THREE.MeshPhongMaterial;case"commonLambert":return THREE.MeshLambertMaterial;case"commonConstant":default:return THREE.MeshBasicMaterial}},r.prototype.extendParams=function(e,a,t){var r=a.extensions[this.name],n=[],s=[];switch(r.type){case"commonBlinn":case"commonPhong":s.push("diffuseFactor","diffuseTexture","specularFactor","specularTexture","shininessFactor");break;case"commonLambert":s.push("diffuseFactor","diffuseTexture");break;case"commonConstant":}var i={};return s.forEach(function(e){void 0!==r[e]&&(i[e]=r[e])}),void 0!==i.diffuseFactor&&(e.color=(new THREE.Color).fromArray(i.diffuseFactor),e.opacity=i.diffuseFactor[3]),void 0!==i.diffuseTexture&&n.push(t.assignTexture(e,"map",i.diffuseTexture.index)),void 0!==i.specularFactor&&(e.specular=(new THREE.Color).fromArray(i.specularFactor)),void 0!==i.specularTexture&&n.push(t.assignTexture(e,"specularMap",i.specularTexture.index)),void 0!==i.shininessFactor&&(e.shininess=i.shininessFactor),Promise.all(n)};var d="glTF",m=12,f={JSON:1313821514,BIN:5130562},h={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},T=({5126:Number,35675:THREE.Matrix3,35676:THREE.Matrix4,35664:THREE.Vector2,35665:THREE.Vector3,35666:THREE.Vector4,35678:THREE.Texture},{5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array}),v={9728:THREE.NearestFilter,9729:THREE.LinearFilter,9984:THREE.NearestMipMapNearestFilter,9985:THREE.LinearMipMapNearestFilter,9986:THREE.NearestMipMapLinearFilter,9987:THREE.LinearMipMapLinearFilter},R={33071:THREE.ClampToEdgeWrapping,33648:THREE.MirroredRepeatWrapping,10497:THREE.RepeatWrapping},g={6406:THREE.AlphaFormat,6407:THREE.RGBFormat,6408:THREE.RGBAFormat,6409:THREE.LuminanceFormat,6410:THREE.LuminanceAlphaFormat},M={5121:THREE.UnsignedByteType,32819:THREE.UnsignedShort4444Type,32820:THREE.UnsignedShort5551Type,33635:THREE.UnsignedShort565Type},S=({1028:THREE.BackSide,1029:THREE.FrontSide},{512:THREE.NeverDepth,513:THREE.LessDepth,514:THREE.EqualDepth,515:THREE.LessEqualDepth,516:THREE.GreaterEqualDepth,517:THREE.NotEqualDepth,518:THREE.GreaterEqualDepth,519:THREE.AlwaysDepth},{32774:THREE.AddEquation,32778:THREE.SubtractEquation,32779:THREE.ReverseSubtractEquation},{0:THREE.ZeroFactor,1:THREE.OneFactor,768:THREE.SrcColorFactor,769:THREE.OneMinusSrcColorFactor,770:THREE.SrcAlphaFactor,771:THREE.OneMinusSrcAlphaFactor,772:THREE.DstAlphaFactor,773:THREE.OneMinusDstAlphaFactor,774:THREE.DstColorFactor,775:THREE.OneMinusDstColorFactor,776:THREE.SrcAlphaSaturateFactor},{SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16}),H={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},L={CATMULLROMSPLINE:THREE.InterpolateSmooth,CUBICSPLINE:THREE.InterpolateSmooth,LINEAR:THREE.InterpolateLinear,STEP:THREE.InterpolateDiscrete},A={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};return p.prototype._withDependencies=function(e){for(var a={},t=0;t<e.length;t++){var r=e[t],n="load"+r.charAt(0).toUpperCase()+r.slice(1),s=this.cache.get(r);if(void 0!==s)a[r]=s;else if(this[n]){var o=this[n]();this.cache.add(r,o),a[r]=o}}return i(a,function(e){return e})},p.prototype.parse=function(e,a){var t=this.json,r=this;this.cache.removeAll(),this._withDependencies(["scenes","animations"]).then(function(n){var s=n.scenes||[],i=s[t.scene||0],o=n.animations||[];r.getDependencies("camera").then(function(a){e(i,s,a,o)}).catch(a)}).catch(a)},p.prototype.getDependency=function(e,a){var t=e+":"+a,r=this.cache.get(t);if(!r){var n="load"+e.charAt(0).toUpperCase()+e.slice(1);r=this[n](a),this.cache.add(t,r)}return r},p.prototype.getDependencies=function(e){var a=this,t=this.json[e+"s"]||[];return Promise.all(t.map(function(t,r){return a.getDependency(e,r)}))},p.prototype.loadBuffer=function(e){var a=this.json.buffers[e],t=this.fileLoader;if(a.type&&"arraybuffer"!==a.type)throw new Error("THREE.GLTFLoader: "+a.type+" buffer type is not supported.");if(void 0===a.uri&&0===e)return Promise.resolve(this.extensions[E.KHR_BINARY_GLTF].body);var r=this.options;return new Promise(function(e,n){t.load(o(a.uri,r.path),e,void 0,function(){n(new Error('THREE.GLTFLoader: Failed to load buffer "'+a.uri+'".'))})})},p.prototype.loadBufferView=function(e){var a=this.json.bufferViews[e];return this.getDependency("buffer",a.buffer).then(function(e){var t=a.byteLength||0,r=a.byteOffset||0;return e.slice(r,r+t)})},p.prototype.loadAccessors=function(){var e=this,a=this.json;return i(a.accessors,function(t){return e.getDependency("bufferView",t.bufferView).then(function(e){var r,n=S[t.type],s=T[t.componentType],i=s.BYTES_PER_ELEMENT,o=i*n,l=a.bufferViews[t.bufferView].byteStride,u=t.normalized===!0;if(l&&l!==o){r=new s(e);var c=new THREE.InterleavedBuffer(r,l/i);return new THREE.InterleavedBufferAttribute(c,n,t.byteOffset/i,u)}return r=new s(e,t.byteOffset,t.count*n),new THREE.BufferAttribute(r,n,u)})})},p.prototype.loadTexture=function(e){var a=this,t=this.json,r=this.options,n=this.textureLoader,s=window.URL||window.webkitURL,i=t.textures[e],l=t.images[i.source],u=l.uri,c=!1;return void 0!==l.bufferView&&(u=a.getDependency("bufferView",l.bufferView).then(function(e){c=!0;var a=new Blob([e],{type:l.mimeType});return u=s.createObjectURL(a)})),Promise.resolve(u).then(function(e){var a=THREE.Loader.Handlers.get(e)||n;return new Promise(function(t,n){altspace&&altspace.inClient?(texture=new THREE.Texture({src:o(sourceUri,r.path)}),t(texture)):a.load(o(e,r.path),t,void 0,n)})}).then(function(e){c===!0&&s.revokeObjectURL(u),e.flipY=!1,void 0!==i.name&&(e.name=i.name),e.format=void 0!==i.format?g[i.format]:THREE.RGBAFormat,void 0!==i.internalFormat&&e.format!==g[i.internalFormat]&&console.warn("THREE.GLTFLoader: Three.js does not support texture internalFormat which is different from texture format. internalFormat will be forced to be the same value as format."),e.type=void 0!==i.type?M[i.type]:THREE.UnsignedByteType;var a=t.samplers||{},r=a[i.sampler]||{};return e.magFilter=v[r.magFilter]||THREE.LinearFilter,e.minFilter=v[r.minFilter]||THREE.LinearMipMapLinearFilter,e.wrapS=R[r.wrapS]||THREE.RepeatWrapping,e.wrapT=R[r.wrapT]||THREE.RepeatWrapping,e})},p.prototype.assignTexture=function(e,a,t){return this.getDependency("texture",t).then(function(t){e[a]=t})},p.prototype.loadMaterials=function(){var e=this,a=this.json,t=this.extensions;return i(a.materials,function(a){var r,n={},s=a.extensions||{},i=[];if(s[E.KHR_MATERIALS_COMMON]){var o=t[E.KHR_MATERIALS_COMMON];r=o.getMaterialType(a),i.push(o.extendParams(n,a,e))}else if(s[E.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var l=t[E.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];r=l.getMaterialType(a),i.push(l.extendParams(n,a,e))}else if(void 0!==a.pbrMetallicRoughness){r=THREE.MeshStandardMaterial;var u=a.pbrMetallicRoughness;if(n.color=new THREE.Color(1,1,1),n.opacity=1,Array.isArray(u.baseColorFactor)){var c=u.baseColorFactor;n.color.fromArray(c),n.opacity=c[3]}if(void 0!==u.baseColorTexture&&i.push(e.assignTexture(n,"map",u.baseColorTexture.index)),n.metalness=void 0!==u.metallicFactor?u.metallicFactor:1,n.roughness=void 0!==u.roughnessFactor?u.roughnessFactor:1,void 0!==u.metallicRoughnessTexture){var p=u.metallicRoughnessTexture.index;i.push(e.assignTexture(n,"metalnessMap",p)),i.push(e.assignTexture(n,"roughnessMap",p))}}else r=THREE.MeshPhongMaterial;a.doubleSided===!0&&(n.side=THREE.DoubleSide);var d=a.alphaMode||A.OPAQUE;return d!==A.OPAQUE?(n.transparent=!0,d===A.MASK&&(n.alphaTest=void 0!==a.alphaCutoff?a.alphaCutoff:.5)):n.transparent=!1,void 0!==a.normalTexture&&(i.push(e.assignTexture(n,"normalMap",a.normalTexture.index)),n.normalScale=new THREE.Vector2(1,1),void 0!==a.normalTexture.scale&&n.normalScale.set(a.normalTexture.scale,a.normalTexture.scale)),void 0!==a.occlusionTexture&&(i.push(e.assignTexture(n,"aoMap",a.occlusionTexture.index)),void 0!==a.occlusionTexture.strength&&(n.aoMapIntensity=a.occlusionTexture.strength)),void 0!==a.emissiveFactor&&(r===THREE.MeshBasicMaterial?n.color=(new THREE.Color).fromArray(a.emissiveFactor):n.emissive=(new THREE.Color).fromArray(a.emissiveFactor)),void 0!==a.emissiveTexture&&(r===THREE.MeshBasicMaterial?i.push(e.assignTexture(n,"map",a.emissiveTexture.index)):i.push(e.assignTexture(n,"emissiveMap",a.emissiveTexture.index))),Promise.all(i).then(function(){var e;return e=r===THREE.ShaderMaterial?t[E.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(n):new r(n),void 0!==a.name&&(e.name=a.name),e.normalScale&&(e.normalScale.x=-e.normalScale.x),e.map&&(e.map.encoding=THREE.sRGBEncoding),e.emissiveMap&&(e.emissiveMap.encoding=THREE.sRGBEncoding),a.extras&&(e.userData=a.extras),e})})},p.prototype.loadGeometries=function(e){return this._withDependencies(["accessors"]).then(function(a){return i(e,function(e){var t=new THREE.BufferGeometry,r=e.attributes;for(var n in r){var s=r[n];if(void 0===s)return;var i=a.accessors[s];switch(n){case"POSITION":t.addAttribute("position",i);break;case"NORMAL":t.addAttribute("normal",i);break;case"TEXCOORD_0":case"TEXCOORD0":case"TEXCOORD":t.addAttribute("uv",i);break;case"TEXCOORD_1":t.addAttribute("uv2",i);break;case"COLOR_0":case"COLOR0":case"COLOR":t.addAttribute("color",i);break;case"WEIGHTS_0":case"WEIGHT":t.addAttribute("skinWeight",i);break;case"JOINTS_0":case"JOINT":t.addAttribute("skinIndex",i)}}return void 0!==e.indices&&t.setIndex(a.accessors[e.indices]),t})})},p.prototype.loadMeshes=function(){var e=this,a=this.json,t=this.extensions;return this._withDependencies(["accessors","materials"]).then(function(r){return i(a.meshes,function(a,n){var s=new THREE.Group,i=a.primitives||[];return e.loadGeometries(i).then(function(e){for(var o=0;o<i.length;o++){var l=i[o],p=e[o],d=void 0===l.material?u():r.materials[l.material];d.aoMap&&void 0===p.attributes.uv2&&void 0!==p.attributes.uv&&(console.log("THREE.GLTFLoader: Duplicating UVs to support aoMap."),p.addAttribute("uv2",new THREE.BufferAttribute(p.attributes.uv.array,2)));var m=void 0!==p.attributes.color,f=void 0===p.attributes.normal;if(m||f)if(d.isGLTFSpecularGlossinessMaterial){var T=t[E.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];d=T.cloneMaterial(d)}else d=d.clone();m&&(d.vertexColors=THREE.VertexColors,d.needsUpdate=!0),f&&(d.flatShading=!0);var v;if(l.mode===h.TRIANGLES||void 0===l.mode)v=new THREE.Mesh(p,d);else if(l.mode===h.TRIANGLE_STRIP)v=new THREE.Mesh(p,d),v.drawMode=THREE.TriangleStripDrawMode;else if(l.mode===h.TRIANGLE_FAN)v=new THREE.Mesh(p,d),v.drawMode=THREE.TriangleFanDrawMode;else if(l.mode===h.LINES)v=new THREE.LineSegments(p,d);else if(l.mode===h.LINE_STRIP)v=new THREE.Line(p,d);else if(l.mode===h.LINE_LOOP)v=new THREE.LineLoop(p,d);else{if(l.mode!==h.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: ",l.mode);v=new THREE.Points(p,d)}if(v.name=a.name||"mesh_"+n,void 0!==l.targets&&c(v,a,l,r),l.extras&&(v.userData=l.extras),!(i.length>1))return v;v.name+="_"+o,s.add(v)}return s})})})},p.prototype.loadCamera=function(e){var a,t=this.json.cameras[e],r=t[t.type];if(!r)return void console.warn("THREE.GLTFLoader: Missing camera parameters.");if("perspective"===t.type){var n=r.aspectRatio||1,s=r.yfov*n;a=new THREE.PerspectiveCamera(THREE.Math.radToDeg(s),n,r.znear||1,r.zfar||2e6)}else"orthographic"===t.type&&(a=new THREE.OrthographicCamera(r.xmag/-2,r.xmag/2,r.ymag/2,r.ymag/-2,r.znear,r.zfar));return void 0!==t.name&&(a.name=t.name),t.extras&&(a.userData=t.extras),Promise.resolve(a)},p.prototype.loadSkins=function(){var e=this.json;return this._withDependencies(["accessors"]).then(function(a){return i(e.skins,function(e){var t={joints:e.joints,inverseBindMatrices:a.accessors[e.inverseBindMatrices]};return t})})},p.prototype.loadAnimations=function(){var e=this.json;return this._withDependencies(["accessors","nodes"]).then(function(a){return i(e.animations,function(e,t){for(var r=[],n=0;n<e.channels.length;n++){var s=e.channels[n],i=e.samplers[s.sampler];if(i){var o=s.target,l=void 0!==o.node?o.node:o.id,u=void 0!==e.parameters?e.parameters[i.input]:i.input,c=void 0!==e.parameters?e.parameters[i.output]:i.output,p=a.accessors[u],E=a.accessors[c],d=a.nodes[l];if(d){d.updateMatrix(),d.matrixAutoUpdate=!0;var m;switch(H[o.path]){case H.weights:m=THREE.NumberKeyframeTrack;break;case H.rotation:m=THREE.QuaternionKeyframeTrack;break;case H.position:case H.scale:default:m=THREE.VectorKeyframeTrack}var f=d.name?d.name:d.uuid;"CATMULLROMSPLINE"===i.interpolation&&console.warn("THREE.GLTFLoader: CATMULLROMSPLINE interpolation is not supported. Using CUBICSPLINE instead.");var h=void 0!==i.interpolation?L[i.interpolation]:THREE.InterpolateLinear,T=[];H[o.path]===H.weights?d.traverse(function(e){e.isMesh===!0&&e.material.morphTargets===!0&&T.push(e.name?e.name:e.uuid)}):T.push(f);for(var v=0,R=T.length;v<R;v++)r.push(new m(T[v]+"."+H[o.path],THREE.AnimationUtils.arraySlice(p.array,0),THREE.AnimationUtils.arraySlice(E.array,0),h))}}}var l=void 0!==e.name?e.name:"animation_"+t;return new THREE.AnimationClip(l,(void 0),r)})})},p.prototype.loadNodes=function(){for(var e=this.json,a=this.extensions,t=this,r=e.nodes||[],n=e.skins||[],s={},o={},l=0;l<n.length;l++)for(var u=n[l].joints,c=0;c<u.length;++c)r[u[c]].isBone=!0;for(var p=0;p<r.length;p++){var d=r[p];void 0!==d.mesh&&(void 0===s[d.mesh]&&(s[d.mesh]=o[d.mesh]=0),s[d.mesh]++)}return t._withDependencies(["meshes","skins","cameras"]).then(function(r){return i(e.nodes,function(e){if(e.isBone===!0)return new THREE.Bone;if(void 0!==e.mesh){var n=r.meshes[e.mesh].clone();return s[e.mesh]>1&&(n.name+="_instance_"+o[e.mesh]++),n}if(void 0!==e.camera)return t.getDependency("camera",e.camera);if(e.extensions&&e.extensions[E.KHR_LIGHTS]&&void 0!==e.extensions[E.KHR_LIGHTS].light){var i=a[E.KHR_LIGHTS].lights;return i[e.extensions[E.KHR_LIGHTS].light]}return new THREE.Object3D}).then(function(a){return i(a,function(t,n){var s=e.nodes[n];if(void 0!==s.name&&(t.name=THREE.PropertyBinding.sanitizeNodeName(s.name)),s.extras&&(t.userData=s.extras),void 0!==s.matrix){var i=new THREE.Matrix4;i.fromArray(s.matrix),t.applyMatrix(i)}else void 0!==s.translation&&t.position.fromArray(s.translation),void 0!==s.rotation&&t.quaternion.fromArray(s.rotation),void 0!==s.scale&&t.scale.fromArray(s.scale);if(void 0!==s.skin){for(var o=[],l=t.children.length>0?t.children:[t],u=0;u<l.length;u++){var c=l[u],p=r.skins[s.skin],E=c.geometry,d=c.material;d.skinning=!0;var m=new THREE.SkinnedMesh(E,d);m.morphTargetInfluences=c.morphTargetInfluences,m.userData=c.userData,m.name=c.name;for(var f=[],h=[],T=0,v=p.joints.length;T<v;T++){var R=p.joints[T],g=a[R];if(g){f.push(g);var M=p.inverseBindMatrices.array,S=(new THREE.Matrix4).fromArray(M,16*T);h.push(S)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',R)}m.bind(new THREE.Skeleton(f,h),m.matrixWorld),o.push(m)}t.children.length>0?(t.remove.apply(t,t.children),t.add.apply(t,o)):t=o[0]}return t})})})},p.prototype.loadScenes=function(){function e(t,r,n){var s=n[t];r.add(s);var i=a.nodes[t];if(i.children)for(var o=i.children,l=0,u=o.length;l<u;l++){var c=o[l];e(c,s,n)}}var a=this.json,t=this.extensions;return this._withDependencies(["nodes"]).then(function(r){return i(a.scenes,function(a){var n=new THREE.Scene;void 0!==a.name&&(n.name=a.name),a.extras&&(n.userData=a.extras);for(var s=a.nodes||[],i=0,o=s.length;i<o;i++){var l=s[i];e(l,n,r.nodes)}if(n.traverse(function(e){e.material&&e.material.isGLTFSpecularGlossinessMaterial&&(e.onBeforeRender=t[E.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].refreshUniforms)}),a.extensions&&a.extensions[E.KHR_LIGHTS]&&void 0!==a.extensions[E.KHR_LIGHTS].light){var u=t[E.KHR_LIGHTS].lights;n.add(u[a.extensions[E.KHR_LIGHTS].light])}return n})})},e}();